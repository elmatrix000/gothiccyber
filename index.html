<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GothAlienBoy — Grid Collapse</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #010707;
  color: #7fffe6;
  font-family: monospace;
  overflow: hidden;
}

#game {
  width: 100vw;
  height: 100vh;
}

canvas {
  width: 100% !important;
  height: 100% !important;
  touch-action: none;
}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================= CONFIG ================= */

const W = 360;
const H = 640;

const config = {
  type: Phaser.AUTO,
  parent: "game",
  width: W,
  height: H,
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  physics: {
    default: "arcade",
    arcade: { gravity: { y: 0 } }
  },
  scene: { create, update }
};

new Phaser.Game(config);

/* ================= STATE ================= */

let player, enemies, bullets, enemyBullets;
let move = 0;
let velocity = 0;
let canShoot = true;
let signal = 100;
let phase = 1;
let gameOver = false;

/* ================= AUDIO (CODE ONLY) ================= */

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function beep(freq, time = 0.08, type = "square") {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  o.connect(g);
  g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + time);
  o.start();
  o.stop(audioCtx.currentTime + time);
}

/* ================= CREATE ================= */

function create() {
  this.bg = this.add.rectangle(0,0,W,H,0x021010).setOrigin(0);
  this.grid = this.add.graphics();

  player = this.add.rectangle(W/2, H-90, 26, 26, 0x00ffd0);
  this.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);

  bullets = this.physics.add.group();
  enemyBullets = this.physics.add.group();
  enemies = this.physics.add.group();

  spawnFormation(this);

  this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);
  this.physics.add.overlap(enemyBullets, player, hitPlayer, null, this);

  ui(this);
}

/* ================= UPDATE ================= */

function update(time) {
  if (gameOver) return;

  drawGrid(this, time);

  velocity += move * 1.4;
  velocity *= 0.88;
  player.body.setVelocityX(velocity * 30);

  enemies.children.each(e => {
    if (!e) return;
    e.y += e.speed;
    e.x += Math.sin(time*0.002 + e.phase) * e.sway;

    if (Phaser.Math.Between(0, 220) === 1) fireEnemy(this, e);
  });

  signal -= 0.005 * phase;
  if (signal <= 0) end(this);
}

/* ================= VISUALS ================= */

function drawGrid(scene, time) {
  scene.grid.clear();
  scene.grid.lineStyle(1, 0x044f47, 0.4 + phase*0.1);
  for (let y=0;y<H;y+=40) {
    scene.grid.lineBetween(
      0, y + (time*0.03*phase)%40,
      W, y + (time*0.03*phase)%40
    );
  }
}

/* ================= GAMEPLAY ================= */

function spawnFormation(scene) {
  for (let i=0;i<4+phase;i++) {
    const e = scene.add.rectangle(
      60 + i*50,
      -60,
      22,
      22,
      0xff3355
    );
    scene.physics.add.existing(e);
    e.speed = 0.5 + phase*0.2;
    e.sway = 1 + phase*0.4;
    e.phase = Math.random()*6;
    enemies.add(e);
  }
}

function shoot(scene) {
  if (!canShoot || gameOver) return;

  signal -= 1.5;
  beep(900 + phase*200);

  const b = scene.add.rectangle(player.x, player.y-20, 4, 14, 0x00ffff);
  scene.physics.add.existing(b);
  b.body.setVelocityY(-500);
  bullets.add(b);

  canShoot = false;
  scene.time.delayedCall(150 + phase*40, ()=>canShoot=true);
}

function fireEnemy(scene, e) {
  beep(220, 0.05, "sawtooth");
  const b = scene.add.rectangle(e.x, e.y+14, 4, 12, 0xff8800);
  scene.physics.add.existing(b);
  b.body.setVelocityY(200 + phase*40);
  enemyBullets.add(b);
}

function hitEnemy(b, e) {
  b.destroy(); e.destroy();
  signal += 6;
  beep(1200, 0.04, "triangle");

  if (enemies.countActive(true) === 0) {
    phase++;
    spawnFormation(this);
  }
}

function hitPlayer() {
  beep(90, 0.2, "sawtooth");
  signal -= 20;
}

/* ================= UI ================= */

function ui(scene) {
  scene.signalText = scene.add.text(10,10,"SIGNAL 100",{fontSize:"14px"});
  scene.phaseText = scene.add.text(10,28,"PHASE 1",{fontSize:"12px"});

  const style = {fontSize:"24px",backgroundColor:"#111",color:"#00ffd0",padding:{x:14,y:6}};
  const L = scene.add.text(20,H-60,"◀",style).setInteractive();
  const R = scene.add.text(80,H-60,"▶",style).setInteractive();
  const F = scene.add.text(W-70,H-60,"⦿",style).setInteractive();

  L.on("pointerdown",()=>move=-1);
  L.on("pointerup",()=>move=0);
  L.on("pointerout",()=>move=0);
  R.on("pointerdown",()=>move=1);
  R.on("pointerup",()=>move=0);
  R.on("pointerout",()=>move=0);
  F.on("pointerdown",()=>shoot(scene));

  scene.events.on("update",()=>{
    scene.signalText.setText("SIGNAL "+Math.floor(signal));
    scene.phaseText.setText("PHASE "+phase);
  });
}

/* ================= END ================= */

function end(scene) {
  gameOver = true;
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(
    W/2,H/2,
    "GRID COLLAPSED\nSIGNAL LOST",
    {fontSize:"20px",color:"#ff3355",align:"center"}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
