<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>GothAlienBoy — Total Grid Break</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>

<style>
html, body {
  margin: 0;
  padding: 0;
  background: #010707;
  color: #7fffe6;
  font-family: monospace;
  overflow: hidden;
}
#game { width: 100vw; height: 100vh; }
canvas {
  width: 100% !important;
  height: 100% !important;
  touch-action: none;
}
</style>
</head>

<body>
<div id="game"></div>

<script>
/* ================= CONFIG ================= */

const W = 360;
const H = 640;

const config = {
  type: Phaser.AUTO,
  parent: "game",
  width: W,
  height: H,
  scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH },
  physics: { default: "arcade", arcade: { gravity: { y: 0 } } },
  scene: { create, update }
};

new Phaser.Game(config);

/* ================= AUDIO ================= */

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function sound(freq, dur=0.08, type="square") {
  const o = audioCtx.createOscillator();
  const g = audioCtx.createGain();
  o.type = type;
  o.frequency.value = freq;
  o.connect(g);
  g.connect(audioCtx.destination);
  g.gain.setValueAtTime(0.15, audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
  o.start();
  o.stop(audioCtx.currentTime + dur);
}

/* ================= STATE ================= */

let player, enemies, bullets, enemyBullets, boss;
let move = 0, vel = 0;
let signal = 100;
let phase = 1;
let canShoot = true;
let slowTime = false;
let gameOver = false;

/* ================= CREATE ================= */

function create() {
  this.bg = this.add.rectangle(0,0,W,H,0x021010).setOrigin(0);
  this.grid = this.add.graphics();

  player = this.add.rectangle(W/2,H-90,26,26,0x00ffd0);
  this.physics.add.existing(player);
  player.body.setCollideWorldBounds(true);

  bullets = this.physics.add.group();
  enemyBullets = this.physics.add.group();
  enemies = this.physics.add.group();

  spawnWave(this);
  this.physics.add.overlap(bullets,enemies,killEnemy,null,this);
  this.physics.add.overlap(enemyBullets,player,hitPlayer,null,this);

  ui(this);
  story(this, "PHASE 1\nTHE GRID DETECTS ANOMALY");
}

/* ================= UPDATE ================= */

function update(time) {
  if (gameOver) return;

  drawGrid(this,time);

  vel += move * 1.4;
  vel *= 0.86;
  player.body.setVelocityX(vel*30);

  enemies.children.each(e=>{
    if(!e) return;
    e.y += e.speed * (slowTime?0.3:1);
    e.x += Math.sin(time*0.002 + e.phase) * e.sway;
    if(Phaser.Math.Between(0,200)===1) fireEnemy(this,e);
  });

  if(boss) bossBehavior(this,time);

  signal -= 0.004 * phase;
  if(signal<=0) end(this);
}

/* ================= VISUALS ================= */

function drawGrid(scene,time){
  scene.grid.clear();
  scene.grid.lineStyle(1,0x044f47,0.3+phase*0.1);
  for(let y=0;y<H;y+=40){
    scene.grid.lineBetween(0,y+(time*0.03)%40,W,y+(time*0.03)%40);
  }
}

/* ================= GAMEPLAY ================= */

function spawnWave(scene){
  for(let i=0;i<4+phase;i++){
    const e = scene.add.rectangle(
      40+i*50,-60,22,22,0xff3355
    );
    scene.physics.add.existing(e);
    e.speed = 0.6+phase*0.2;
    e.sway = 1+phase*0.4;
    e.phase = Math.random()*6;
    enemies.add(e);
  }
}

function shoot(scene){
  if(!canShoot||gameOver) return;
  signal-=1.5;
  sound(900+phase*120);
  const spread = phase>=4?[-6,0,6]:[0];
  spread.forEach(dx=>{
    const b = scene.add.rectangle(player.x+dx,player.y-20,4,14,0x00ffff);
    scene.physics.add.existing(b);
    b.body.setVelocityY(-500);
    bullets.add(b);
  });
  canShoot=false;
  scene.time.delayedCall(140,()=>canShoot=true);
}

function fireEnemy(scene,e){
  sound(200,0.05,"sawtooth");
  const b = scene.add.rectangle(e.x,e.y+14,4,12,0xff8800);
  scene.physics.add.existing(b);
  b.body.setVelocityY(220+phase*30);
  enemyBullets.add(b);
}

function killEnemy(b,e){
  b.destroy(); e.destroy();
  signal+=5;
  sound(1200,0.04,"triangle");
  sceneShake(this,4);
  if(enemies.countActive(true)===0 && !boss){
    phase++;
    if(phase===3) spawnBoss(this);
    else {
      story(this,"PHASE "+phase+"\nSIGNAL ESCALATION");
      spawnWave(this);
    }
  }
}

function hitPlayer(){
  sound(80,0.2,"sawtooth");
  signal-=15;
  sceneShake(this,8);
}

function spawnBoss(scene){
  boss = scene.add.rectangle(W/2,-100,160,80,0xff5500);
  scene.physics.add.existing(boss);
  boss.hp = 40;
  scene.physics.add.overlap(bullets,boss,hitBoss,null,scene);
  story(scene,"CORE NODE ONLINE\nTERMINATE RUNNER");
}

function bossBehavior(scene,time){
  boss.y += 0.4;
  boss.x = W/2 + Math.sin(time*0.002)*80;
  if(Phaser.Math.Between(0,50)===1){
    fireEnemy(scene,boss);
    fireEnemy(scene,boss);
  }
}

function hitBoss(b){
  b.destroy();
  boss.hp--;
  sound(600,0.05);
  sceneShake(this,6);
  if(boss.hp<=0){
    boss.destroy();
    end(this,true);
  }
}

/* ================= EFFECTS ================= */

function sceneShake(scene,intensity){
  scene.cameras.main.shake(120,intensity/100);
}

function story(scene,text){
  const box = scene.add.rectangle(0,0,W,H,0x000000,0.8).setOrigin(0);
  const t = scene.add.text(W/2,H/2,text,{
    fontSize:"18px",align:"center",color:"#00ffd0"
  }).setOrigin(0.5);
  scene.time.delayedCall(1600,()=>{
    box.destroy(); t.destroy();
  });
}

/* ================= UI ================= */

function ui(scene){
  scene.sText = scene.add.text(10,10,"SIGNAL",{fontSize:"14px"});
  scene.pText = scene.add.text(10,28,"PHASE 1",{fontSize:"12px"});
  const style={fontSize:"24px",backgroundColor:"#111",color:"#00ffd0",padding:{x:14,y:6}};
  const L=scene.add.text(20,H-60,"◀",style).setInteractive();
  const R=scene.add.text(80,H-60,"▶",style).setInteractive();
  const F=scene.add.text(W-70,H-60,"⦿",style).setInteractive();
  L.on("pointerdown",()=>move=-1);
  L.on("pointerup",()=>move=0);
  L.on("pointerout",()=>move=0);
  R.on("pointerdown",()=>move=1);
  R.on("pointerup",()=>move=0);
  R.on("pointerout",()=>move=0);
  F.on("pointerdown",()=>shoot(scene));
  scene.events.on("update",()=>{
    scene.sText.setText("SIGNAL "+Math.floor(signal));
    scene.pText.setText("PHASE "+phase);
  });
}

/* ================= END ================= */

function end(scene,win=false){
  gameOver=true;
  scene.add.rectangle(0,0,W,H,0x000000,0.9).setOrigin(0);
  scene.add.text(
    W/2,H/2,
    win?
    "GRID DESTROYED\nGOTHALIENBOY IS FREE":
    "SIGNAL LOST\nTHE GRID CONSUMES YOU",
    {fontSize:"20px",align:"center",color:win?"#00ffd0":"#ff3355"}
  ).setOrigin(0.5);
}
</script>
</body>
</html>
